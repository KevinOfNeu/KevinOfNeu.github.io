
<!DOCTYPE html>
<html lang="">


<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#202020"/>
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>
  
  
    <meta name="keywords" content="redux," />
  

  
    <meta name="description" content="KevinOfNeu&#39;s Blog | 叫兽的博客 | 思绪偶尔在这里停留 | 三关茅庐 | 博客 | 叫兽" />
  
  
  <link rel="icon" type="image/x-icon" href="/logo.png">
  <title>Redux 架构概览和原理剖析 [ 叫兽的博客 ]</title>
  
    <!-- stylesheets list from config.yml -->
    
      <link rel="stylesheet" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css">
    
      <link rel="stylesheet" href="/css/xoxo.css">
    
  
</head>


<body>
  <div class="nav-container">
    <nav class="home-menu pure-menu pure-menu-horizontal">
  <a class="pure-menu-heading" href="/">
    <img class="avatar" src="https://blog.0xff000000.com/images/logo.png">
    <span class="title">叫兽的博客</span>
  </a>

  <ul class="pure-menu-list clearfix">
      
          
            <li class="pure-menu-item"><a href="/" class="pure-menu-link">首页</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/archives" class="pure-menu-link">归档</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/tags" class="pure-menu-link">标签</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/search" class="pure-menu-link">搜索</a></li>
          
      
          
            <li class="pure-menu-item"><a href="https://0xff000000.com" class="pure-menu-link">关于</a></li>
          
      
          
            <li class="pure-menu-item"><a href="/atom.xml" class="pure-menu-link">订阅</a></li>
          
      
  </ul>
   
</nav>
  </div>

  <div class="container" id="content-outer">
    <div class="inner" id="content-inner">
      <div class="post-container">
  <article class="post" id="post">
    <header class="post-header text-center">
      <h1 class="title">
        Redux 架构概览和原理剖析
      </h1>
      <span>
        
        <time class="time" datetime="2021-02-26T12:30:00.000Z">
        2021-02-26
      </time>
        
      </span>
      <span class="slash">/</span>
      <span class="post-meta">
      <span class="post-tags">
        <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redux/">redux</a></li></ul>
      </span>
    </span>
      <span class="slash">/</span>
      <span class="read">
      <span id="busuanzi_value_page_pv"></span> 点击
    </span>
      <span class="slash">/</span>
      <span class="read">阅读耗时 40 分钟</span>
    </header>

    <div class="post-content">
      <p><img src="https://images.unsplash.com/photo-1461749280684-dccba630e2f6?ixlib=rb-1.2.1&amp;ixid=MXwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHw%3D&amp;auto=format&amp;fit=crop&amp;w=1950&amp;q=80" alt=""></p>
<blockquote>
<p>本文非完整的开发指南，具体开发细节请参考官网文档。里面涉及的一些基础概念，翻译自官方文档。<br>本文主要阐述了 Redux 设计的核心概念，梳理了涉及到的知识结构，方便你能快速地对 Redux 有一个完整的认知。<br>在此基础上，探索了 Redux 框架的一些基本原理和部分源码的解读。<br>最后做了一些扩展和延伸。<br>需要着重申明的是，Redux 本身很简单，简单并不总是意味着容易。Redux 也很强大，作为一种非常简洁优雅的状态管理方案，可以支撑起各种复杂的应用逻辑。随着 Kotlin MultiPlatfrom 的发展，Redux 架构方案也会有更多的应用场景 (纯粹个人预测)。</p>
</blockquote>
<h1 id="0-介绍"><a href="#0-介绍" class="headerlink" title="0. 介绍"></a>0. 介绍</h1><p>一言以蔽之: Redux 是一种可预测的状态管理容器 <a href="https://redux.js.org/introduction/getting-started" target="_blank" rel="noopener">^1</a>。</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>Redux 经常和 React 框架一起配合使用，当然 Vue 也是如此。虽然 Redux 本身非常小(只有 2kb)，但是却又非常强大的社区生态。</p>
<p>下面简单说一下 Redux 的安装使用(可以直接跳到 <a href="#1.总览和概念">总览和概念</a> 这一部分, 并不影响阅读，你可以把下面的部分当做链接导航来使用)。</p>
<h3 id="Redux-Toolkit"><a href="#Redux-Toolkit" class="headerlink" title="Redux Toolkit"></a>Redux Toolkit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> NPM</span></span><br><span class="line">npm install @reduxjs/toolkit</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Yarn</span></span><br><span class="line">yarn add @reduxjs/toolkit</span><br></pre></td></tr></table></figure>
<h3 id="Redux-Core"><a href="#Redux-Core" class="headerlink" title="Redux Core"></a>Redux Core</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> NPM</span></span><br><span class="line">npm install redux</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Yarn</span></span><br><span class="line">yarn add redux</span><br></pre></td></tr></table></figure>
<h3 id="其他补充"><a href="#其他补充" class="headerlink" title="其他补充"></a>其他补充</h3><p>假设你在使用 React 框架，那么你很有可能需要下面的依赖：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm install react-redux</span><br><span class="line">npm install --save-dev redux-devtools</span><br></pre></td></tr></table></figure></p>
<h3 id="创建-React-Redux-App"><a href="#创建-React-Redux-App" class="headerlink" title="创建 React Redux App"></a>创建 React Redux App</h3><p><code>npx create-react-app my-app --template redux</code></p>
<p><small>更多细节参见<a href="https://redux.js.org/introduction/installation" target="_blank" rel="noopener">官方文档1</a></small></p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><p><small>更多细节参见<a href="https://redux.js.org/introduction/core-concepts" target="_blank" rel="noopener">官方文档2</a></small></p>
<h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><p><small>更多细节参见<a href="https://redux.js.org/introduction/learning-resources" target="_blank" rel="noopener">官方文档3</a></small></p>
<h2 id="社区生态"><a href="#社区生态" class="headerlink" title="社区生态"></a>社区生态</h2><p><small>更多细节参见<a href="https://redux.js.org/introduction/ecosystem" target="_blank" rel="noopener">官方文档4</a></small></p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p><small>更多细节参见<a href="https://redux.js.org/introduction/examples" target="_blank" rel="noopener">官方文档5</a></small></p>
<h1 id="1-总览和概念"><a href="#1-总览和概念" class="headerlink" title="1. 总览和概念"></a>1. 总览和概念</h1><h2 id="什么是-Redux"><a href="#什么是-Redux" class="headerlink" title="什么是 Redux"></a>什么是 Redux</h2><blockquote>
<p><strong>Redux is a pattern and library for managing and updating application state, using events called “actions”.</strong> It serves as a centralized store for state that needs to be used across your entire application, with rules ensuring that the state can only be updated in a predictable fashion.</p>
</blockquote>
<p>翻译：Redux 是一种编程模式，主要用来管理应用状态，通过 <code>Action</code> 来更新状态。它包含了贯穿整个应用生命周期的状态，称之为 <code>Store</code>, 还有一些规则来保障状态可以被“可预测的”更新。</p>
<h2 id="为什么用-Redux"><a href="#为什么用-Redux" class="headerlink" title="为什么用 Redux"></a>为什么用 Redux</h2><p>官网的章节<a href="https://redux.js.org/tutorials/essentials/part-1-overview-concepts#when-should-i-use-redux" target="_blank" rel="noopener">^2</a>是这么描述的：Redux 帮助你管理整个应用共享的“全局状态“。<br>Redux 让我们更好的理解状态何时何地以及为什么以及怎样被更新的，并且让我们的应用逻辑可预测。Redux 让我们映红可预测，更方便做测试，怎强了应用的鲁棒性。</p>
<h2 id="什么时候用-Redux"><a href="#什么时候用-Redux" class="headerlink" title="什么时候用 Redux"></a>什么时候用 Redux</h2><p>Redux 和其他工具一样，需要我们做出一些折中。需要我们了解更多的概念，代码量也会增加，代码的编程模式也有更多的限制。在如下场景，从长期来看，短期的妥协还是值得：</p>
<ul>
<li>应用内各模块经常需要状态共享</li>
<li>应用状态更新频繁</li>
<li>更新状态的逻辑复杂</li>
<li>应用属于中等或者重量级规模，而且有多人协作</li>
</ul>
<p><strong>Redux 并不是银弹，你需要仔细思考Redux 是否解决你目前遇到的问题，再决定是否使用它。</strong></p>
<h2 id="术语和概念"><a href="#术语和概念" class="headerlink" title="术语和概念"></a>术语和概念</h2><p>在真正开始之前，我们先解释一下 Redux 相关的概念和术语。</p>
<h3 id="状态管理（State-Management）"><a href="#状态管理（State-Management）" class="headerlink" title="状态管理（State Management）"></a>状态管理（State Management）</h3><p>以计数器(点击按钮，计数器增加 1)为例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Counter</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// State: a counter value</span></span><br><span class="line">  <span class="keyword">const</span> [counter, setCounter] = useState(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Action: code that causes an update to the state when something happens</span></span><br><span class="line">  <span class="keyword">const</span> increment = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    setCounter(<span class="function"><span class="params">prevCounter</span> =&gt;</span> prevCounter + <span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// View: the UI definition</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      Value: &#123;counter&#125; &lt;button onClick=&#123;increment&#125;&gt;Increment&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>div&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>例子包含三部分：</p>
<ul>
<li>State，应用的数据源</li>
<li>View，基于 State 的数据驱动 UI 组件</li>
<li>Actions，用户触发的事件，更新 State</li>
</ul>
<p>这是一个简单的 ”单项数据流“ 的应用：</p>
<ul>
<li>State 描述了某一个应用的状态</li>
<li>UI 的渲染基于 State</li>
<li>对于用户的点击等输入，Sate 会根据具体场景更新当前值</li>
<li>UI 的重绘基于新的 State</li>
</ul>
<p align="center"><br>    <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/2021-02-23-082521.jpg" width="600"><br></p>

<p>计数器的例子比较简单，但是当多个组件消费同一个 State 会让应用越来越复杂，尤其是当组件分布在应用的不同部分。当然，可以通过把 State 提升到功共同父组件来解决，但是实际场景可能不总是这样。</p>
<p>另一个解法，可以通过把状态从组件树中抽离到全局，这样，我们的组件树可以看做 <code>View</code> ，包含的各个组件就可以共享 State 了。</p>
<p>通过重新定义 <code>View</code> 和 <code>State</code> 的概念，并且把两者区分来看，可以增强代码结构的可读性和可维护性。</p>
<p>这就是 Redux 背后的基础概念: 中心化存储应用共享的全局状态，以及更新状态的规则，以此让应用行为变得可预测。</p>
<h3 id="不可变（Immutability）"><a href="#不可变（Immutability）" class="headerlink" title="不可变（Immutability）"></a>不可变（Immutability）</h3><p>字面意思。</p>
<p>Javascript 对象和数组默认都是可变的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;</span><br><span class="line"><span class="comment">// still the same object outside, but the contents have changed</span></span><br><span class="line">obj.b = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line"><span class="comment">// In the same way, we can change the contents of this array</span></span><br><span class="line">arr.push(<span class="string">'c'</span>)</span><br><span class="line">arr[<span class="number">1</span>] = <span class="string">'d'</span></span><br></pre></td></tr></table></figure></p>
<p>例子中，我们更改了内存中相同引用的对象或者数组。</p>
<p>通过拷贝对象和数组，我们来实现 “不可变”。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> obj = &#123;</span><br><span class="line">  a: &#123;</span><br><span class="line">    <span class="comment">// To safely update obj.a.c, we have to copy each piece</span></span><br><span class="line">    c: <span class="number">3</span></span><br><span class="line">  &#125;,</span><br><span class="line">  b: <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> obj2 = &#123;</span><br><span class="line">  <span class="comment">// copy obj</span></span><br><span class="line">  ...obj,</span><br><span class="line">  <span class="comment">// overwrite a</span></span><br><span class="line">  a: &#123;</span><br><span class="line">    <span class="comment">// copy obj.a</span></span><br><span class="line">    ...obj.a,</span><br><span class="line">    <span class="comment">// overwrite c</span></span><br><span class="line">    c: <span class="number">42</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arr = [<span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line"><span class="comment">// Create a new copy of arr, with "c" appended to the end</span></span><br><span class="line"><span class="keyword">const</span> arr2 = arr.concat(<span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// or, we can make a copy of the original array:</span></span><br><span class="line"><span class="keyword">const</span> arr3 = arr.slice()</span><br><span class="line"><span class="comment">// and mutate the copy:</span></span><br><span class="line">arr3.push(<span class="string">'c'</span>)</span><br></pre></td></tr></table></figure>
<p>Redux 中约定，状态更新都是“不可变” 更新。</p>
<h3 id="一些术语"><a href="#一些术语" class="headerlink" title="一些术语"></a>一些术语</h3><h4 id="Actions"><a href="#Actions" class="headerlink" title="Actions"></a>Actions</h4><p>Action 就是一个有 <code>type</code> 字段的普通 JavaScript 对象，它描述了事件的一些元信息。</p>
<p><code>type</code> 字符串描述了 Action 的名字，例如 <code>todos/todoAdded</code>。</p>
<p>Action 对象可以包含其他字段来来做数据负载，根据约定我们一般叫做 <code>payload</code>:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> addTodoAction = &#123;</span><br><span class="line">  type: <span class="string">'todos/todoAdded'</span>,</span><br><span class="line">  payload: <span class="string">'Buy milk'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Action-Creators"><a href="#Action-Creators" class="headerlink" title="Action Creators"></a>Action Creators</h4><p>创建 Action, 避免每次实例化 Action 手写重复样板代码。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> addTodo = <span class="function"><span class="params">text</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: <span class="string">'todos/todoAdded'</span>,</span><br><span class="line">    payload: text</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Reducers"><a href="#Reducers" class="headerlink" title="Reducers"></a>Reducers</h4><p>纯函数，参数是当前的 <code>state</code> 和 <code>action</code>, 输出更新后的 <code>newState</code>,  函数签名<code>(state, action) =&gt; newState</code>。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> initialState = &#123; <span class="attr">value</span>: <span class="number">0</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">counterReducer</span>(<span class="params">state = initialState, action</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Check to see if the reducer cares about this action</span></span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'counter/increment'</span>) &#123;</span><br><span class="line">    <span class="comment">// If so, make a copy of `state`</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...state,</span><br><span class="line">      <span class="comment">// and update the copy with the new value</span></span><br><span class="line">      value: state.value + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// otherwise return the existing state unchanged</span></span><br><span class="line">  <span class="keyword">return</span> state</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Store"><a href="#Store" class="headerlink" title="Store"></a>Store</h4><p>Redux 应用的状态存储一个叫做 <code>store</code> 的对象。</p>
<p>store 是通过传递 <code>reducer</code> 给 <code>configureStore</code> 来创建的，并且有一个 <code>getState</code> 的方法返回当前的状态。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; configureStore &#125; <span class="keyword">from</span> <span class="string">'@reduxjs/toolkit'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = configureStore(&#123; <span class="attr">reducer</span>: counterReducer &#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(store.getState())</span><br><span class="line"><span class="comment">// &#123;value: 0&#125;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Dispatch"><a href="#Dispatch" class="headerlink" title="Dispatch"></a>Dispatch</h4><p><code>store</code> 有另一个方法 <code>dispatch</code>, 更新 <code>state</code> 的唯一方法就是通过调用 <code>store.dispatch()</code> 函数并且提供一个 <code>action</code> 参数来实现的。<code>store</code> 运行上述我们编写的  <code>reducer</code> ，<code>state</code> 的值更新，然后我们可以通过 <code>getState()</code> 获得更新后的值。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">store.dispatch(&#123; <span class="attr">type</span>: <span class="string">'counter/increment'</span> &#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(store.getState())</span><br><span class="line"><span class="comment">// &#123;value: 1&#125;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Selectors"><a href="#Selectors" class="headerlink" title="Selectors"></a>Selectors</h4><p><code>Selector</code> 是析构 <code>store</code> 里状态的特定信息的函数。随着应用增长，Selector 可以降低解析同样数据的重复代码。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> selectCounterValue = <span class="function"><span class="params">state</span> =&gt;</span> state.value</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> currentValue = selectCounterValue(store.getState())</span><br><span class="line"><span class="built_in">console</span>.log(currentValue)</span><br><span class="line"><span class="comment">// 2</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Middleware"><a href="#Middleware" class="headerlink" title="Middleware"></a>Middleware</h4><p>Middleware 提供了从 <code>dispatch</code>  一个 <code>action</code> 到被<code>reducer</code>处理之前一种扩展机制，可以用来打印日志，打印错误堆栈，发起异步调用等。</p>
<h4 id="Redux-Thunk"><a href="#Redux-Thunk" class="headerlink" title="Redux-Thunk"></a>Redux-Thunk</h4><p>是一种 Middleware，增强 Redux 使其可以 <code>dispatch</code> 一个异步处理函数而非一个简单对象。</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><p>以官网的 <a href="https://github.com/reduxjs/redux/tree/v3.6.0/examples/async" target="_blank" rel="noopener">example/async</a>为例。</p>
<h3 id="src-目录结构"><a href="#src-目录结构" class="headerlink" title="src 目录结构"></a>src 目录结构</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├── actions</span><br><span class="line">│   └── index.js</span><br><span class="line">├── components</span><br><span class="line">│   ├── Picker.js</span><br><span class="line">│   └── Posts.js</span><br><span class="line">├── containers</span><br><span class="line">│   └── App.js</span><br><span class="line">├── index.js</span><br><span class="line">└── reducers</span><br><span class="line">    └── index.js</span><br><span class="line"> |── index.js</span><br></pre></td></tr></table></figure>
<h3 id="index-js"><a href="#index-js" class="headerlink" title="index.js"></a>index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123; render &#125; <span class="keyword">from</span> <span class="string">'react-dom'</span></span><br><span class="line"><span class="keyword">import</span> &#123; createStore, applyMiddleware &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123; Provider &#125; <span class="keyword">from</span> <span class="string">'react-redux'</span></span><br><span class="line"><span class="keyword">import</span> thunk <span class="keyword">from</span> <span class="string">'redux-thunk'</span></span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span></span><br><span class="line"><span class="keyword">import</span> reducer <span class="keyword">from</span> <span class="string">'./reducers'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./containers/App'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> middleware = [thunk, createLogger()]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware(...middleware)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">render(</span><br><span class="line">  &lt;Provider store=&#123;store&#125;&gt;</span><br><span class="line">    &lt;App /&gt;</span><br><span class="line">  &lt;<span class="regexp">/Provider&gt;,</span></span><br><span class="line"><span class="regexp">  document.getElementById('root')</span></span><br><span class="line"><span class="regexp">)</span></span><br></pre></td></tr></table></figure>
<p>这里主要是做了创建 Store 以及一些和 React 框架绑定的事情（Provider, 可以参考 <code>react-redux</code> ）。</p>
<p>这里还涉及到了 middleware 和 thunk，是非常核心的概念，后面会详细解析，但目前不影响理解。</p>
<h3 id="actions-index-js"><a href="#actions-index-js" class="headerlink" title="actions/index.js"></a>actions/index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> REQUEST_POSTS = <span class="string">'REQUEST_POSTS'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> RECEIVE_POSTS = <span class="string">'RECEIVE_POSTS'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> SELECT_REDDIT = <span class="string">'SELECT_REDDIT'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> INVALIDATE_REDDIT = <span class="string">'INVALIDATE_REDDIT'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">selectReddit</span>(<span class="params">reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: SELECT_REDDIT,</span><br><span class="line">    reddit</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">invalidateReddit</span>(<span class="params">reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: INVALIDATE_REDDIT,</span><br><span class="line">    reddit</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">requestPosts</span>(<span class="params">reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: REQUEST_POSTS,</span><br><span class="line">    reddit</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receivePosts</span>(<span class="params">reddit, json</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: RECEIVE_POSTS,</span><br><span class="line">    reddit,</span><br><span class="line">    posts: json.data.children.map(<span class="function"><span class="params">child</span> =&gt;</span> child.data),</span><br><span class="line">    receivedAt: <span class="built_in">Date</span>.now()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fetchPosts</span>(<span class="params">reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">dispatch</span> =&gt;</span> &#123;</span><br><span class="line">    dispatch(requestPosts(reddit))</span><br><span class="line">    <span class="keyword">return</span> fetch(<span class="string">`https://www.reddit.com/r/<span class="subst">$&#123;reddit&#125;</span>.json`</span>)</span><br><span class="line">      .then(<span class="function"><span class="params">response</span> =&gt;</span> response.json())</span><br><span class="line">      .then(<span class="function"><span class="params">json</span> =&gt;</span> dispatch(receivePosts(reddit, json)))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldFetchPosts</span>(<span class="params">state, reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> posts = state.postsByReddit[reddit]</span><br><span class="line">  <span class="keyword">if</span> (!posts) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (posts.isFetching) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> posts.didInvalidate</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">fetchPostsIfNeeded</span>(<span class="params">reddit</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch, getState</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldFetchPosts(getState(), reddit)) &#123;</span><br><span class="line">      <span class="keyword">return</span> dispatch(fetchPosts(reddit))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里只要定义了 action， 以及发送请求的部分。</p>
<h3 id="reducers-index-js"><a href="#reducers-index-js" class="headerlink" title="reducers/index.js"></a>reducers/index.js</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; combineReducers &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  SELECT_REDDIT, INVALIDATE_REDDIT,</span><br><span class="line">  REQUEST_POSTS, RECEIVE_POSTS</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">'../actions'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selectedReddit</span>(<span class="params">state = <span class="string">'reactjs'</span>, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> SELECT_REDDIT:</span><br><span class="line">      <span class="keyword">return</span> action.reddit</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">posts</span>(<span class="params">state = &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  isFetching: false,</span></span></span><br><span class="line"><span class="function"><span class="params">  didInvalidate: false,</span></span></span><br><span class="line"><span class="function"><span class="params">  items: []</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> INVALIDATE_REDDIT:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        didInvalidate: <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> REQUEST_POSTS:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        isFetching: <span class="literal">true</span>,</span><br><span class="line">        didInvalidate: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">case</span> RECEIVE_POSTS:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        isFetching: <span class="literal">false</span>,</span><br><span class="line">        didInvalidate: <span class="literal">false</span>,</span><br><span class="line">        items: action.posts,</span><br><span class="line">        lastUpdated: action.receivedAt</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">postsByReddit</span>(<span class="params">state = &#123; &#125;, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> INVALIDATE_REDDIT:</span><br><span class="line">    <span class="keyword">case</span> RECEIVE_POSTS:</span><br><span class="line">    <span class="keyword">case</span> REQUEST_POSTS:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        ...state,</span><br><span class="line">        [action.reddit]: posts(state[action.reddit], action)</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rootReducer = combineReducers(&#123;</span><br><span class="line">  postsByReddit,</span><br><span class="line">  selectedReddit</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> rootReducer</span><br></pre></td></tr></table></figure>
<p>主要是 reducer 纯函数部分。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>containers/App.js</code> 和 <code>components/*.js</code> 主要是一些 UI 逻辑，本身并不复杂，这里可自行看官网代码。</p>
<h1 id="2-Redux-原理解读"><a href="#2-Redux-原理解读" class="headerlink" title="2. Redux 原理解读"></a>2. Redux 原理解读</h1><h2 id="Redux-数据流向"><a href="#Redux-数据流向" class="headerlink" title="Redux 数据流向"></a>Redux 数据流向</h2><p>首先来看一张没有 Middleware 时候的数据流向图，这对后面理解 Middleware 非常有帮助。</p>
<p align="center"><br>    <img src="https://redux.js.org/assets/images/ReduxDataFlowDiagram-49fa8c3968371d9ef6f2a1486bd40a26.gif" width="600"><br></p>

<p align="center"><br>    图 2.1  Data Flow 示意图<br></p>

<h2 id="Middleware-1"><a href="#Middleware-1" class="headerlink" title="Middleware"></a>Middleware</h2><p>首先来完整的介绍一下 Middleware。</p>
<p>Middleware 提供了从 <code>dispatch</code>  一个 <code>action</code> 到被<code>reducer</code>处理之前一种扩展机制，可以用来打印日志，打印错误堆栈，发起异步调用等。</p>
<p>Middleware 主要用来处理异步逻辑（Redux 本身其实并不关心异步逻辑，所有异步操作都需要放到 Store 之外执行）。</p>
<ul>
<li>当 action 被 dispatch 的时候，处理额外的逻辑，比如打日志记录 action 和 state</li>
<li>暂定，修改，延时，替换, 停止 action</li>
<li>添加额外代码，可以访问 dispatch 和 getState</li>
<li>改造 dispatch，使其可以接受除了 action 对象之外的类型，比如函数或者 promise，其原理是拦截这些新的类型，然后转换成真正的 action 对象</li>
</ul>
<p>Redux 有很多 middleware，最常见的就是 <code>redux-thunk</code> 了，允许你编写含有异步逻辑的函数。</p>
<p>前面章节我们分析了 Redux 的数据流是怎样运转的，当我们引入异步概念后，在 dispatch action 之前我们可以在 middleware 中编写类似发送网络请求的逻辑。更新后的数据流如图 2.2 所示。</p>
<p align="center"><br>    <img src="https://redux.js.org/assets/images/ReduxAsyncDataFlowDiagram-d97ff38a0f4da0f327163170ccc13e80.gif" width="600"><br></p><br><p align="center"><br>    图 2.2 Middleware 示意图<br></p>

<h3 id="使用-Middleware"><a href="#使用-Middleware" class="headerlink" title="使用 Middleware"></a>使用 Middleware</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; applyMiddleware, createStore &#125; <span class="keyword">from</span> <span class="string">'redux'</span>;</span><br><span class="line"><span class="keyword">import</span> createLogger <span class="keyword">from</span> <span class="string">'redux-logger'</span>;</span><br><span class="line"><span class="keyword">const</span> logger = createLogger();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware(logger)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>Redux 提供了 <code>applyMiddleware</code> 方法，该方法支持多个 Middleware 参数传入，例如  <code>applyMiddleware(thunk, promise, logger)</code> , 并且对于参数的顺序敏感，后面会提到为什么，这里只要记住 logger 要放到最后一个才能正常工作。</p>
<p>当 <code>applyMiddleware</code>  调用结束后，会返回 <code>store</code> 的增强版本，然后传递给 <code>createStore</code> 就完成了 Middleware 的应用。</p>
<p>下面将详解这中间发生的过程。</p>
<h3 id="剖析-Middleware"><a href="#剖析-Middleware" class="headerlink" title="剖析 Middleware"></a>剖析 Middleware</h3><p>首先我们来看一下 <code>applyMiddleware.js</code> 的源码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> (reducer, preloadedState, enhancer) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> store = createStore(reducer, preloadedState, enhancer)</span><br><span class="line">    <span class="keyword">var</span> dispatch = store.dispatch</span><br><span class="line">    <span class="keyword">var</span> chain = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</span><br><span class="line">    &#125;</span><br><span class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>该方法主要作用是用来增强 Store 的 <code>dispatch</code> 方法，也叫做 <code>store enhancer</code>。该方法的入参是 middlware 的列表，返回值就是增强后的 Store 了，而且紧紧替换了 <code>dispatch</code> 方法。</p>
<p>虽然代码不多，但是初看确实不好理解。在真正分析源码之前我们首先要了解函数式编程里的两个概念：柯里化和函数组合。</p>
<h4 id="柯里化（Currying）"><a href="#柯里化（Currying）" class="headerlink" title="柯里化（Currying）"></a>柯里化（Currying）</h4><p><a href="https://zh.wikipedia.org/wiki/%E6%9F%AF%E9%87%8C%E5%8C%96" target="_blank" rel="noopener">柯里化</a>接受多个参数的函数变换成接受一个单一参数（最初函数的第一个参数）的函数，并且返回接受余下的参数而且返回结果的新函数的技术。</p>
<p>说人话，假设有函数 <code>f(x,y) = x + y</code>，未经柯里化之前 <code>f(2,3) = 2 + 3 = 5</code><br>对于柯里化我们可以这样处理:<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先定义 f-2 = (2, y) = 2 + y</span><br><span class="line">因此</span><br><span class="line">f(2,3) = f-2(y)= f-2(3) = 2 + 3 = 5</span><br></pre></td></tr></table></figure></p>
<h4 id="函数组合（Composing-Functions）"><a href="#函数组合（Composing-Functions）" class="headerlink" title="函数组合（Composing Functions）"></a>函数组合（Composing Functions）</h4><p><a href="https://en.wikipedia.org/wiki/Function_composition_(computer_science)" target="_blank" rel="noopener">函数组合</a> 是通过把一个个简单函数作为参数传递给下一个函数来组合成复杂函数的机制。</p>
<p>假设有：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f(x) = x^2 + 3x + 1</span><br><span class="line">g(x) = 2x</span><br></pre></td></tr></table></figure></p>
<p>那么<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(f * g)(x) = f(g(x)) = f(2x) = 4x^2 + 6x + 1</span><br></pre></td></tr></table></figure></p>
<p>在 JavaScript 实现函数组合效果是通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/ReduceRight" target="_blank" rel="noopener">Array.prototype.reduceRight</a> 来实现的。</p>
<blockquote>
<p><code>reduceRight()</code> 方法接受一个函数作为累加器（accumulator）和数组的每个值（从右到左）将其减少为单个值。</p>
</blockquote>
<p>举例：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> array1 = [[<span class="number">0</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">3</span>], [<span class="number">4</span>, <span class="number">5</span>]].reduceRight(</span><br><span class="line">  (accumulator, currentValue) =&gt; accumulator.concat(currentValue)</span><br><span class="line">);</span><br><span class="line"><span class="built_in">console</span>.log(array1);</span><br><span class="line"><span class="comment">// expected output: Array [4, 5, 2, 3, 0, 1]</span></span><br></pre></td></tr></table></figure></p>
<p>我们再来看一下 <code>compose.js</code> 的代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> last = funcs[funcs.length - <span class="number">1</span>]</span><br><span class="line">  <span class="keyword">const</span> rest = funcs.slice(<span class="number">0</span>, <span class="number">-1</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> rest.reduceRight(<span class="function">(<span class="params">composed, f</span>) =&gt;</span> f(composed), last(...args))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>composed</code> 就是上一次累计的结果，初始值是 <code>last(...args)</code>。执行顺序从右到左，因此第一次 reduce的累加器 <code>(composed, f) =&gt; f(composed)</code>  展开代码：<br><code>(last(...args), f) =&gt; f(last(..args))</code>, 以此类推。</p>
<p>来一个小 demo 验证一下:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> hello = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Hello, <span class="subst">$&#123; x &#125;</span>`</span> </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> world = <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123; </span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;x&#125;</span>!`</span> </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> compose = <span class="function"><span class="keyword">function</span>(<span class="params">f, g</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">x</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> f(g(x));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> helloworld = compose(hello, world);</span><br><span class="line">helloworld(<span class="string">"world"</span>)</span><br></pre></td></tr></table></figure></p>
<p>最终输出结果 <code>&quot;Hello, world!&quot;</code>。</p>
<h4 id="再看-applyMiddleware-js-代码"><a href="#再看-applyMiddleware-js-代码" class="headerlink" title="再看 applyMiddleware.js 代码"></a>再看 applyMiddleware.js 代码</h4><p>有了前面的铺垫后，就万事俱备了。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">applyMiddleware</span>(<span class="params">...middlewares</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">createStore</span>) =&gt;</span> (reducer, preloadedState, enhancer) =&gt; &#123;</span><br><span class="line">    <span class="keyword">var</span> store = createStore(reducer, preloadedState, enhancer)</span><br><span class="line">    <span class="keyword">var</span> dispatch = store.dispatch</span><br><span class="line">    <span class="keyword">var</span> chain = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</span><br><span class="line">    &#125;</span><br><span class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>首先 <code>applyMiddleware</code> 返回的是一个匿名函数，在使用 Middleware 一节我们提到 <code>applyMiddleware</code> 是作为 <code>createStore</code> 参数传递下去的。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> store = createStore(</span><br><span class="line">  reducer,</span><br><span class="line">  applyMiddleware([ myMiddleware1, myMiddleware2, myMiddleware3])</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>我们来看一下 <code>createStore.js</code> 中 <code>createStore</code> 的核心代码：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">  <span class="comment">//部分防护代码删掉</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//部分防护代码删掉...</span></span><br><span class="line">  <span class="comment">//其他关键部分</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;...&#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;...&#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;...&#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;...&#125;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    subscribe,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p><code>applyMiddleware</code> 返回的匿名函数就是 <code>enhancer</code> 这个参数，因此代码会执行到：</p>
<p><code>return enhancer(createStore)(reducer, preloadedState)</code></p>
<p>这里 <code>createStore</code> 把自身引用传递到了 <code>applyMiddleware</code>，即匿名函数的第一个参数 <code>createStore</code>，applyMiddleware 代码此时会执行到：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> store = createStore(reducer, preloadedState, enhancer)</span><br></pre></td></tr></table></figure></p>
<p>知识点来了哦… 此时调用栈代码又回到了 <code>createStore</code> 方法，但此刻 <code>enhancer</code> 参数为空，因此此时 <code>createStore</code> 不会提前 <code>return</code>， 而是老老实实初始化，最终返回一个 Store 对象：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">   dispatch,</span><br><span class="line">   subscribe,</span><br><span class="line">   getState,</span><br><span class="line">   replaceReducer,</span><br><span class="line">   [$$observable]: observable</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>记住此刻，store 是未经过增强的，执行完毕后，再回到 <code>applyMiddleware</code>  函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> chain = []</span><br><span class="line">   <span class="keyword">var</span> middlewareAPI = &#123;</span><br><span class="line">     getState: store.getState,</span><br><span class="line">     dispatch: <span class="function">(<span class="params">action</span>) =&gt;</span> dispatch(action)</span><br><span class="line">   &#125;</span><br><span class="line">   chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">   dispatch = compose(...chain)(store.dispatch)</span><br></pre></td></tr></table></figure>
<p>上述几行代码，主要是创建了 middleware 的标准入参（也就是构造 middleware 时候的标准 API），然后遍历 <code>applyMiddleware</code> 传递进来的 middleware 列表，把 <code>{getState, dispatch}</code> 传递给各个 middleware， 最终返回内存中的 middleware 实例。</p>
<p>原本 <code>middleware</code> 的函数声明只这样子的:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(&#123; dispatch, getState &#125;) =&gt; <span class="function">(<span class="params">next</span>) =&gt;</span> (action) =&gt; &#123;</span><br><span class="line"> <span class="comment">//执行下一个 Middleware 之前以及 dispatch action 之前执行的操作</span></span><br><span class="line">    <span class="keyword">let</span> retValue = next(action);</span><br><span class="line"> <span class="comment">//执行完下一个 Middleware 以及 dispatch action 之后执行的操作</span></span><br><span class="line">    <span class="keyword">return</span> retValue;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure></p>
<p>经过上述 <code>chain = middlewares.map(middleware =&gt; middleware(middlewareAPI))</code> 操作后（柯里化的参数应用，消灭掉第一个参数 { dispatch, getState }），<br>内存中的 middleware 转化成如下结构：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(next) =&gt; <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">	 <span class="comment">//执行下一个 Middleware 之前以及 dispatch action 之前执行的操作</span></span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">	 <span class="comment">//执行完下一个 Middleware 以及 dispatch action 之后执行的操作</span></span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>
<p>假设我们有三个 Middleware <code>myMiddleware1, myMiddleware2, myMiddleware3</code> 定义如下：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMiddleware1 = <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> (next) =&gt; <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 1 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myMiddleware2 = <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> (next) =&gt; <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myMiddleware3 = <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> (next) =&gt; <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 3 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 3 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>首先经过第一个参数部分求值后：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> myMiddleware1 = <span class="function">(<span class="params">next</span>) =&gt;</span> (action) =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 1 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myMiddleware2 = <span class="function">(<span class="params">next</span>) =&gt;</span> (action) =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 2 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myMiddleware3 = <span class="function">(<span class="params">next</span>) =&gt;</span> (action) =&gt; &#123;</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 3 start'</span>);</span><br><span class="line">     <span class="keyword">let</span> retValue = next(action);</span><br><span class="line">     <span class="built_in">console</span>.log(<span class="string">'myMiddleware 3 end'</span>);</span><br><span class="line">     <span class="keyword">return</span> retValue;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>接下来就是函数组合，也是 Redux 中精华的部分了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dispatch = compose(...chain)(store.dispatch)</span><br></pre></td></tr></table></figure></p>
<p>转换后的 dispatch 变成如下结构：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dispatch</span> (<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> next =  <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">                  <span class="keyword">var</span> next =  <span class="function">(<span class="params">next</span>) =&gt;</span> &#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">                                  <span class="built_in">console</span>.log(<span class="string">'middleware 3 start'</span>);</span><br><span class="line">                                  (store.dispatch)(action)</span><br><span class="line">                                  <span class="built_in">console</span>.log(<span class="string">'middleware 3 end'</span>);</span><br><span class="line">                                &#125;;</span><br><span class="line">                              &#125;;</span><br><span class="line">                  <span class="keyword">return</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'middleware 2 start'</span>);</span><br><span class="line">                    next(action)</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">'middleware 2 end'</span>);</span><br><span class="line">                  &#125;;</span><br><span class="line">                &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'middleware 1 start'</span>);</span><br><span class="line">        next(action)</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'middleware 2 end'</span>);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>根据展开后的代码可以得出结果，当我们 <code>dispatch</code> 一个 <code>action</code> 的时候，<br>首先会按照从做到右的顺序执行 Middleware, 直到最后一个 Middleware，而最后一个 Middleware 的 next 参数已经在 <code>compose</code> 的过程中被赋值为 <code>(store.dispatch)</code>, 注意此时的 dispatch 是未经过修饰的。因此当 middleware3 执行完毕后，此时 action 才会真正被送到 <code>reducer</code> 进行状态变更。</p>
<p>可以结合图 2.2 来理解。</p>
<p align="center"><br>    <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/2021-02-26-075209.png" width="600"><br></p><br><p align="center"><br>    图 2.2 Middleware 运行机制示意<br></p>

<p>因此控制台输出结果为：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//state</span><br><span class="line">middleware 1 start</span><br><span class="line">middleware 2 start</span><br><span class="line">middleware 3 start</span><br><span class="line">//nextState</span><br><span class="line">middleware 3 end</span><br><span class="line">middleware 2 end</span><br><span class="line">middleware 1 end</span><br></pre></td></tr></table></figure></p>
<p>最后 <code>applyMiddleware</code> 函数返回加强后的整个应用的 <code>store</code> 实例：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">     ...store,</span><br><span class="line">     dispatch</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Middleware-运行机制"><a href="#Middleware-运行机制" class="headerlink" title="Middleware 运行机制"></a>Middleware 运行机制</h4><p>剥洋葱图。</p>
<h4 id="为什么-applyMiddleware-对入参顺序敏感"><a href="#为什么-applyMiddleware-对入参顺序敏感" class="headerlink" title="为什么 applyMiddleware 对入参顺序敏感"></a>为什么 applyMiddleware 对入参顺序敏感</h4><p>以 redux-logger 为例，必须放到最后一个，否则它只能记录 thunk 或者 promise，而非最终的 action，具体<a href="https://github.com/LogRocket/redux-logger/issues/20" target="_blank" rel="noopener">参见</a>。</p>
<p>原理就是如果不放置到最后一个的话，当前的 middlware 并不发送 action，而只是调用 next 传递给下一个 middleware，结合图 2.2，只有 middleware 3 才能记录真正经过 middleware 1 &amp; 2 处理后发送的 action。</p>
<h3 id="Thunk"><a href="#Thunk" class="headerlink" title="Thunk"></a>Thunk</h3><p>Thunk中文翻译有转换程序的意思。下面我们看一下 redux-thunk 到底转换了什么。</p>
<h4 id="剖析-Redux-Thunk-8"><a href="#剖析-Redux-Thunk-8" class="headerlink" title="剖析 Redux-Thunk [^8]"></a>剖析 Redux-Thunk [^8]</h4><p>嗯，redux-thunk 代码就这么多。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createThunkMiddleware</span>(<span class="params">extraArgument</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">&#123; dispatch, getState &#125;</span>) =&gt;</span> (next) =&gt; <span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> action(dispatch, getState, extraArgument);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> next(action);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> thunk = createThunkMiddleware();</span><br><span class="line">thunk.withExtraArgument = createThunkMiddleware;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> thunk;</span><br></pre></td></tr></table></figure></p>
<p>核心逻辑 <code>typeof action === &#39;function&#39;</code> 判断如果是 function，则调用 function。这使得 action 脱离了简单对象的约束，现在可以返回 function 对象。该 function 接受 <code>getState，dispatch</code> 作为参数，可以用来延时 dispatch action。</p>
<p>例如如下 action creator：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> INCREMENT_COUNTER = <span class="string">'INCREMENT_COUNTER'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">increment</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    type: INCREMENT_COUNTER,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">incrementAsync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">dispatch</span>) =&gt;</span> &#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Yay! Can invoke sync or async actions with `dispatch`</span></span><br><span class="line">      dispatch(increment());</span><br><span class="line">    &#125;, <span class="number">1000</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="其他-Middleware"><a href="#其他-Middleware" class="headerlink" title="其他 Middleware"></a>其他 Middleware</h3><h4 id="Redux-Logger"><a href="#Redux-Logger" class="headerlink" title="Redux-Logger"></a>Redux-Logger</h4><p>去掉各种细节逻辑，处理逻辑也很简单，就是在 returnedValue 前后记录一些信息。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(&#123; getState &#125;) =&gt; <span class="function"><span class="params">next</span> =&gt;</span> (action) =&gt; &#123;</span><br><span class="line">	log....</span><br><span class="line">    <span class="keyword">let</span> returnedValue;</span><br><span class="line">    returnedValue = next(action);</span><br><span class="line">	log....</span><br><span class="line">    <span class="keyword">return</span> returnedValue;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure></p>
<p>细节实现参见<a href="https://github.com/LogRocket/redux-logger" target="_blank" rel="noopener">redux-logger代码</a></p>
<h4 id="Redux-Saga"><a href="#Redux-Saga" class="headerlink" title="Redux-Saga"></a>Redux-Saga</h4><blockquote>
<p>redux-saga 是一个用于管理应用程序 Side Effect（副作用，例如异步获取数据，访问浏览器缓存等）的 library，它的目标是让副作用管理更容易，执行更高效，测试更简单，在处理故障时更容易。</p>
</blockquote>
<blockquote>
<p>可以想像为，一个 saga 就像是应用程序中一个单独的线程，它独自负责处理副作用。 redux-saga 是一个 redux 中间件，意味着这个线程可以通过正常的 redux action 从主应用程序启动，暂停和取消，它能访问完整的 redux state，也可以 dispatch redux action。</p>
</blockquote>
<p><a href="https://github.com/redux-saga/redux-saga" target="_blank" rel="noopener">redux-saga</a> 源码稍微有点多，后面考虑单独开坑来写。</p>
<h4 id="Redux-Promise"><a href="#Redux-Promise" class="headerlink" title="Redux-Promise"></a>Redux-Promise</h4><p>支持 promise 对象。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">promiseMiddleware</span>(<span class="params">&#123; dispatch &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">next</span> =&gt;</span> action =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isFSA(action)) &#123;</span><br><span class="line">      <span class="keyword">return</span> isPromise(action) ? action.then(dispatch) : next(action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> isPromise(action.payload)</span><br><span class="line">      ? action.payload</span><br><span class="line">          .then(<span class="function"><span class="params">result</span> =&gt;</span> dispatch(&#123; ...action, <span class="attr">payload</span>: result &#125;))</span><br><span class="line">          .catch(<span class="function"><span class="params">error</span> =&gt;</span> &#123;</span><br><span class="line">            dispatch(&#123; ...action, <span class="attr">payload</span>: error, <span class="attr">error</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.reject(error);</span><br><span class="line">          &#125;)</span><br><span class="line">      : next(action);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>更多信息参考<a href="https://github.com/redux-utilities/redux-promise" target="_blank" rel="noopener">redux-promise 代码</a></p>
<h1 id="2-Think-in-Redux"><a href="#2-Think-in-Redux" class="headerlink" title="2. Think in Redux"></a>2. Think in Redux</h1><h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><p>当 “变化” 和 “异步” 混在一起，会让我们的应用越来越复杂，就类似<a href="https://en.wikipedia.org/wiki/Diet_Coke_and_Mentos_eruption" target="_blank" rel="noopener">曼妥思和可乐</a>混在一起，后果可想而知。</p>
<p>类似于 React 框架分离 View 和对 DOM 的操作，但是应用状态的管理缺撒手不管，这就是 Redux 存在的意义。</p>
<p>随着应用复杂度的提高，我们需要管理越来越多的状态，Redux 让我们重新掌握对状态管理的控制权。</p>
<h2 id="三个原则"><a href="#三个原则" class="headerlink" title="三个原则"></a>三个原则</h2><h3 id="单一来源-（Single-Source-of-Truth）"><a href="#单一来源-（Single-Source-of-Truth）" class="headerlink" title="单一来源 （Single Source of Truth）"></a>单一来源 （Single Source of Truth）</h3><p>应用的全局状态只存在单一对象 <code>store</code> 中。</p>
<h3 id="仅可读状态-（State-is-Read-Only）"><a href="#仅可读状态-（State-is-Read-Only）" class="headerlink" title="仅可读状态 （State is Read-Only）"></a>仅可读状态 （State is Read-Only）</h3><p>更改应用状态的唯一方法就是 <code>dispatch</code> 一个 <code>action</code>。</p>
<h3 id="一切变更来自纯函数（Changes-are-made-with-pure-functions）"><a href="#一切变更来自纯函数（Changes-are-made-with-pure-functions）" class="headerlink" title="一切变更来自纯函数（Changes are made with pure functions）"></a>一切变更来自纯函数（Changes are made with pure functions）</h3><p>根据 <code>action</code> 转换 <code>state</code> 的方法(也就是 <code>reducer</code>) 必须是纯函数。</p>
<h1 id="3-更多教程"><a href="#3-更多教程" class="headerlink" title="3. 更多教程"></a>3. 更多教程</h1><p>实际应用开发中可能会用到的一些案例。</p>
<ul>
<li><a href="https://redux.js.org/recipes/configuring-your-store" target="_blank" rel="noopener">Configuring Your Store</a></li>
<li><a href="https://redux.js.org/recipes/usage-with-typescript" target="_blank" rel="noopener">Usage with TypeScript</a></li>
<li><a href="https://redux.js.org/recipes/migrating-to-redux" target="_blank" rel="noopener">Migrating to Redux</a></li>
<li><a href="https://redux.js.org/recipes/using-object-spread-operator" target="_blank" rel="noopener">Using Object Spread Operator</a></li>
<li><a href="https://redux.js.org/recipes/reducing-boilerplate" target="_blank" rel="noopener">Reducing Boilerplate</a></li>
<li><a href="https://redux.js.org/recipes/server-rendering" target="_blank" rel="noopener">Server Rendering</a></li>
<li><a href="https://redux.js.org/recipes/writing-tests" target="_blank" rel="noopener">Writing Tests</a></li>
<li><a href="https://redux.js.org/recipes/computing-derived-data" target="_blank" rel="noopener">Computing Derived Data</a></li>
<li><a href="https://redux.js.org/recipes/implementing-undo-history" target="_blank" rel="noopener">Implementing Undo History</a></li>
<li><a href="https://redux.js.org/recipes/isolating-redux-sub-apps" target="_blank" rel="noopener">Isolating Redux Sub-Apps</a></li>
<li><a href="https://redux.js.org/recipes/using-immutablejs-with-redux" target="_blank" rel="noopener">Using Immutable.JS with Redux</a></li>
<li><a href="https://redux.js.org/recipes/code-splitting" target="_blank" rel="noopener">Code Splitting</a></li>
<li><a href="https://redux.js.org/recipes/troubleshooting" target="_blank" rel="noopener">Troubleshooting</a></li>
<li><a href="https://redux.js.org/recipes/structuring-reducers/structuring-reducers" target="_blank" rel="noopener">Structuring Reducers</a></li>
</ul>
<h1 id="4-支持平台"><a href="#4-支持平台" class="headerlink" title="4. 支持平台"></a>4. 支持平台</h1><p>本文中默认的都是 JavaScript 版本，由于 Redux 只是一种编程模式，因此可以应用 Android 和 iOS 以及其他 Desktop 的开发技术栈。</p>
<h3 id="JavaScript-版本"><a href="#JavaScript-版本" class="headerlink" title="JavaScript 版本"></a>JavaScript 版本</h3><p><a href="https://github.com/reduxjs/redux" target="_blank" rel="noopener">https://github.com/reduxjs/redux</a></p>
<h3 id="Kotlin-MultiPlatform"><a href="#Kotlin-MultiPlatform" class="headerlink" title="Kotlin MultiPlatform"></a>Kotlin MultiPlatform</h3><p><a href="https://github.com/reduxkotlin/redux-kotlin" target="_blank" rel="noopener">https://github.com/reduxkotlin/redux-kotlin</a></p>
<h1 id="延伸阅读"><a href="#延伸阅读" class="headerlink" title="延伸阅读"></a>延伸阅读</h1><ul>
<li><a href="https://zapier.com/engineering/how-to-build-redux/" target="_blank" rel="noopener">Build Yourself a Redux</a><br>  Build Yourself 系列，从零开始构建一个 Redux 框架。</li>
<li><a href="https://medium.com/@meagle/understanding-87566abcfb7a" target="_blank" rel="noopener">UnderStanding Redux Middleware</a></li>
<li><a href="http://www.ruanyifeng.com/blog/2016/09/redux_tutorial_part_two_async_operations.html" target="_blank" rel="noopener">中间件与异步操作</a></li>
<li><a href="https://github.com/reduxjs/redux/releases/tag/v3.6.0" target="_blank" rel="noopener">Redux 3.6.0 版本代码</a></li>
<li><a href="https://github.com/kenberkeley/redux-simple-tutorial/blob/master/redux-advanced-tutorial.md" target="_blank" rel="noopener">Redux 进阶教程</a></li>
</ul>
<h1 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h1>
    </div>

    <div>全文完。</div>
  </article>
  <div class="toc-container">
    
  <div id="toc" class="toc-article">
    <strong class="toc-title">目录</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0-介绍"><span class="toc-text">0. 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux-Toolkit"><span class="toc-text">Redux Toolkit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redux-Core"><span class="toc-text">Redux Core</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他补充"><span class="toc-text">其他补充</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-React-Redux-App"><span class="toc-text">创建 React Redux App</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#核心概念"><span class="toc-text">核心概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#学习资料"><span class="toc-text">学习资料</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#社区生态"><span class="toc-text">社区生态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#例子"><span class="toc-text">例子</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#1-总览和概念"><span class="toc-text">1. 总览和概念</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是-Redux"><span class="toc-text">什么是 Redux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么用-Redux"><span class="toc-text">为什么用 Redux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#什么时候用-Redux"><span class="toc-text">什么时候用 Redux</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#术语和概念"><span class="toc-text">术语和概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#状态管理（State-Management）"><span class="toc-text">状态管理（State Management）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#不可变（Immutability）"><span class="toc-text">不可变（Immutability）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些术语"><span class="toc-text">一些术语</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Actions"><span class="toc-text">Actions</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Action-Creators"><span class="toc-text">Action Creators</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Reducers"><span class="toc-text">Reducers</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Store"><span class="toc-text">Store</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Dispatch"><span class="toc-text">Dispatch</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Selectors"><span class="toc-text">Selectors</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Middleware"><span class="toc-text">Middleware</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redux-Thunk"><span class="toc-text">Redux-Thunk</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码示例"><span class="toc-text">代码示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#src-目录结构"><span class="toc-text">src 目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#index-js"><span class="toc-text">index.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#actions-index-js"><span class="toc-text">actions/index.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reducers-index-js"><span class="toc-text">reducers/index.js</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他"><span class="toc-text">其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Redux-原理解读"><span class="toc-text">2. Redux 原理解读</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Redux-数据流向"><span class="toc-text">Redux 数据流向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Middleware-1"><span class="toc-text">Middleware</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用-Middleware"><span class="toc-text">使用 Middleware</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#剖析-Middleware"><span class="toc-text">剖析 Middleware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#柯里化（Currying）"><span class="toc-text">柯里化（Currying）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#函数组合（Composing-Functions）"><span class="toc-text">函数组合（Composing Functions）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#再看-applyMiddleware-js-代码"><span class="toc-text">再看 applyMiddleware.js 代码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Middleware-运行机制"><span class="toc-text">Middleware 运行机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#为什么-applyMiddleware-对入参顺序敏感"><span class="toc-text">为什么 applyMiddleware 对入参顺序敏感</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Thunk"><span class="toc-text">Thunk</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#剖析-Redux-Thunk-8"><span class="toc-text">剖析 Redux-Thunk [^8]</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其他-Middleware"><span class="toc-text">其他 Middleware</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Redux-Logger"><span class="toc-text">Redux-Logger</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redux-Saga"><span class="toc-text">Redux-Saga</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redux-Promise"><span class="toc-text">Redux-Promise</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2-Think-in-Redux"><span class="toc-text">2. Think in Redux</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#动机"><span class="toc-text">动机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三个原则"><span class="toc-text">三个原则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#单一来源-（Single-Source-of-Truth）"><span class="toc-text">单一来源 （Single Source of Truth）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#仅可读状态-（State-is-Read-Only）"><span class="toc-text">仅可读状态 （State is Read-Only）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一切变更来自纯函数（Changes-are-made-with-pure-functions）"><span class="toc-text">一切变更来自纯函数（Changes are made with pure functions）</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3-更多教程"><span class="toc-text">3. 更多教程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4-支持平台"><span class="toc-text">4. 支持平台</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JavaScript-版本"><span class="toc-text">JavaScript 版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kotlin-MultiPlatform"><span class="toc-text">Kotlin MultiPlatform</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#延伸阅读"><span class="toc-text">延伸阅读</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考文献"><span class="toc-text">参考文献</span></a></li></ol>
  </div>


  </div>
</div>
<div class="copyright">
    <span>本作品采用</span>
    <a href="https://creativecommons.org/licenses/by/4.0/">知识共享署名 4.0 国际许可协议</a>
    <span>进行许可。 转载时请注明原文链接。</span>
</div>
<div class="share" style="width: 100%;">
  <img src="https://kevinofneu-blog-static.oss-cn-beijing.aliyuncs.com/static/2018-12-10-qrcode_for_gh_ffacf5722095_258.jpg" alt="Running Geek" style="margin: auto; display: block;"/>

  <div style="margin: auto; text-align: center; font-size: 0.8em; color: grey;">老铁们关注走一走，不迷路</div>
  
</div>

  
    <div class="post-nav">
      <div class="post-nav-item post-nav-next">
        
          <span>〈 </span>
          <a href="/2019/04/26/compile-debug-openjdk8-on-osx/" rel="next" title="OSX Mojave 编译 &amp; 源码调试 openJdk 8">
          OSX Mojave 编译 &amp; 源码调试 openJdk 8
          </a>
        
      </div>
  
      <div class="post-nav-item post-nav-prev">
          
      </div>
    </div>
  

  <section class="disqus-comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
  </section>

  <script>
    var disqus_shortname = 'blog-kevinofneu';
    
    var disqus_url = 'https://blog.0xff000000.com/2021/02/26/Redux/';
    
    (function(){
      var dsq = document.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>

  <script id="dsq-count-scr" src="//blog-kevinofneu.disqus.com/count.js" async></script>



    </div>

    

  </div>
  <footer class="footer text-center">
    <div id="bottom-inner">
        <a class="bottom-item" href="https://blog.0xff000000.com">首页</a> |
        <a class="bottom-item" href="https://0xff000000.com" target="_blank">主站</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu" target="_blank">GitHub</a> |
        <a class="bottom-item" href="https://hexo.io" target="_blank">Powered by hexo</a> |
        <a class="bottom-item" href="https://github.com/KevinOfNeu/hexo-theme-xoxo" target="_blank">Theme xoxo</a>
    </div>
</footer>
  

<script>
  (function(window, document, undefined) {

    var timer = null;

    function returnTop() {
      cancelAnimationFrame(timer);
      timer = requestAnimationFrame(function fn() {
        var oTop = document.body.scrollTop || document.documentElement.scrollTop;
        if (oTop > 0) {
          document.body.scrollTop = document.documentElement.scrollTop = oTop - 50;
          timer = requestAnimationFrame(fn);
        } else {
          cancelAnimationFrame(timer);
        }
      });
    }

    var hearts = [];
    window.requestAnimationFrame = (function() {
      return window.requestAnimationFrame ||
        window.webkitRequestAnimationFrame ||
        window.mozRequestAnimationFrame ||
        window.oRequestAnimationFrame ||
        window.msRequestAnimationFrame ||
        function(callback) {
          setTimeout(callback, 1000 / 60);
        }
    })();
    init();

    function init() {
      css(".heart{z-index:9999;width: 10px;height: 10px;position: fixed;background: #f00;transform: rotate(45deg);-webkit-transform: rotate(45deg);-moz-transform: rotate(45deg);}.heart:after,.heart:before{content: '';width: inherit;height: inherit;background: inherit;border-radius: 50%;-webkit-border-radius: 50%;-moz-border-radius: 50%;position: absolute;}.heart:after{top: -5px;}.heart:before{left: -5px;}");
      attachEvent();
      gameloop();
      addMenuEvent();
    }

    function gameloop() {
      for (var i = 0; i < hearts.length; i++) {
        if (hearts[i].alpha <= 0) {
          document.body.removeChild(hearts[i].el);
          hearts.splice(i, 1);
          continue;
        }
        hearts[i].y--;
        hearts[i].scale += 0.004;
        hearts[i].alpha -= 0.013;
        hearts[i].el.style.cssText = "left:" + hearts[i].x + "px;top:" + hearts[i].y + "px;opacity:" + hearts[i].alpha + ";transform:scale(" + hearts[i].scale + "," + hearts[i].scale + ") rotate(45deg);background:" + hearts[i].color;
      }
      requestAnimationFrame(gameloop);
    }

    /**
     * 给logo设置点击事件
     * 
     * - 回到顶部
     * - 出现爱心
     */
    function attachEvent() {
      var old = typeof window.onclick === "function" && window.onclick;
      var logo = document.getElementById("logo");
      if (logo) {
        logo.onclick = function(event) {
          returnTop();
          old && old();
          createHeart(event);
        }
      }
      
    }

    function createHeart(event) {
      var d = document.createElement("div");
      d.className = "heart";
      hearts.push({
        el: d,
        x: event.clientX - 5,
        y: event.clientY - 5,
        scale: 1,
        alpha: 1,
        color: randomColor()
      });
      document.body.appendChild(d);
    }

    function css(css) {
      var style = document.createElement("style");
      style.type = "text/css";
      try {
        style.appendChild(document.createTextNode(css));
      } catch (ex) {
        style.styleSheet.cssText = css;
      }
      document.getElementsByTagName('head')[0].appendChild(style);
    }

    function randomColor() {
      // return "rgb(" + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + "," + (~~(Math.random() * 255)) + ")";
      return "#F44336";
    }

    function addMenuEvent() {
      var menu = document.getElementById('menu-main-post');
      if (menu) {
        var toc = document.getElementById('toc');
        if (toc) {
          menu.onclick = function() {
            if (toc) {
              if (toc.style.display == 'block') {
                toc.style.display = 'none';
              } else {
                toc.style.display = 'block';
              }
            }
          };
        } else {
          menu.style.display = 'none';
        }
      }
    }

  })(window, document);
</script>

  
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?FuckUBaidu";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-116671696-1', 'auto');
      ga('send', 'pageview');
  </script>


</body>
</html>
